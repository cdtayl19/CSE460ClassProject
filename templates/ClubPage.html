<!DOCTYPE html>
<head>
    <title>Club Page</title>
</head>

<body>
    <div class="starter-container">
        
        <div id="info">
            <!-- Store club name -->
            <button id="reqUnflagName" class="reqUnflagBtns" hidden>Request Unflag</button>
            <button id="unflagName" class="adminUnflagBtns" hidden>Unflag</button>
            <button id="flagName" class="adminFlagBtns" hidden>Flag</button>
            <h1 id="Club Name" data-name="{{ club['Club Name'] }}">              
                {{ club["Club Name"] }}
            </h1>
            
            <!-- Store leader -->
            <button id="reqUnflagLdr" class="reqUnflagBtns" hidden>Request Unflag</button>
            <button id="unflagLdr" class="adminUnflagBtns" hidden>Unflag</button>
            <button id="flagLdr" class="adminFlagBtns" hidden>Flag</button>
            <strong>Leader: </strong>
            <span id="Leader" data-name="{{ club['Leader'] }}">{{ club["Leader"] }}</span><br><br>
            
            <button id="reqUnflagTpc" class="reqUnflagBtns" hidden>Request Unflag</button>
            <button id="unflagTpc" class="adminUnflagBtns" hidden>Unflag</button>
            <button id="flagTpc" class="adminFlagBtns" hidden>Flag</button>
            <strong>Topic: </strong>
            <span id="Topic">{{ club["Topic"] }}</span><br><br>

            <button id="reqUnflagDtls" class="reqUnflagBtns" hidden>Request Unflag</button>
            <button id="unflagDtls" class="adminUnflagBtns" hidden>Unflag</button>
            <button id="flagDtls" class="adminFlagBtns" hidden>Flag</button>
            <strong>Details: </strong>
            <span id="Details">{{ club["Details"] }}</span><br><br>

            <button id="reqUnflagMbrs" class="reqUnflagBtns" hidden>Request Unflag</button>
            <button id="unflagMbrs" class="adminUnflagBtns" hidden>Unflag</button>            
            <button id="flagMbrs" class="adminFlagBtns" hidden>Flag</button>
            <strong>Members: </strong>
            <span id="Members">{{ club["Members"] }}</span><br><br>

            <button id="reqUnflagEvts" class="reqUnflagBtns" hidden>Request Unflag</button>
            <button id="unflagEvts" class="adminUnflagBtns" hidden>Unflag</button>
            <button id="flagEvts" class="adminFlagBtns" hidden>Flag</button>
            <strong>Events: </strong>
            <span id="Events">{{ club["Events"] }}</span><br><br>
        </div>
        
        <!--<div id="flagDisplay"></div>-->

        <br>

        <div id="studentButtons" hidden>
            <button id="join">Request to Join!</button>
            <span id="sent" hidden>Your request to join has been sent!</span>
            <button id="studentBackBtn">Back</button>
        </div>

        <div id="leaderButtons" hidden>
            <div id="joinRequests">
                <label id="requests">You have {} new requests. </label>
			    <button id="viewBtn">View</button>
            </div><br>

            <div>
                <button id="createEventBtn">Create Event</button>
                <button id="leaderBackBtn">Back</button>
            </div><br><br>

            
        </div><br>

        <div id="dashboard" hidden>
            <button id="chgName">Change Name</button>
            <button id="chgLeader">Change Leader</button>
            <button id="chgTopic">Change Topic</button>
            <button id="chgDetails">Change Details</button>
            <button id="rmvMembers">Remove Members</button>
            <button id="rmvEvents">Cancel Events</button>
        </div>

        <div id="chgControls" hidden></div>
        <div id="message"></div>
        
        <br>
        <div id="adminDash" hidden>
            <button id="flagBtn">Flag Content</button>
            <button id="adminBackBtn">Back to Admin</button>
            <div id="adminMessage" hidden></div>
        </div>

        <div id="message2"></div>
    </div>

    <script>
        let user = {};
        let clubName = "";
        let flags = [];
        let clubLeader = "";

        function displayFlags() {
            if (flags.length > 0) {
                flags.forEach(flag => {
                    document.getElementById(flag["Section"]).innerText = flag["Message"];
                })
            }

            unflagButtons()
        }

        function unflagButtons() {
            if (document.getElementById("Club Name").innerText == "Content flagged for inappropriateness.") {
                if (user.Role == "admin") {
                    document.getElementById("unflagName").hidden = false;
                    document.getElementById("flagName").hidden = true;
                }

                if (user.Username == leader) {
                    document.getElementById("reqUnflagName").hidden = false;
                }
            }

            if (document.getElementById("Leader").innerText == "Content flagged for inappropriateness.") {
                if (user.Role == "admin") {
                    document.getElementById("unflagLdr").hidden = false;
                    document.getElementById("flagLdr").hidden = true;
                }

                if (user.Username == leader) {
                    document.getElementById("reqUnflagLdr").hidden = false;
                }
            }

            if (document.getElementById("Topic").innerText == "Content flagged for inappropriateness.") {
                if (user.Role == "admin") {
                    document.getElementById("unflagTpc").hidden = false;
                    document.getElementById("flagTpc").hidden = true;
                }

                if (user.Username == leader) {
                    document.getElementById("reqUnflagTpc").hidden = false;
                }
            }

            if (document.getElementById("Details").innerText == "Content flagged for inappropriateness.") {
                if (user.Role == "admin") {
                    document.getElementById("unflagDtls").hidden = false;
                    document.getElementById("flagDtls").hidden = true;
                }

                if (user.Username == leader) {
                    document.getElementById("reqUnflagDtls").hidden = false;
                }
            }

            if (document.getElementById("Members").innerText == "Content flagged for inappropriateness.") {
                if (user.Role == "admin") {
                    document.getElementById("unflagMbrs").hidden = false;
                    document.getElementById("flagMbrs").hidden = true;
                }

                if (user.Username == leader) {
                    document.getElementById("reqUnflagMbrs").hidden = false;
                }
            }

            if (document.getElementById("Events").innerText == "Content flagged for inappropriateness.") {
                if (user.Role == "admin") {
                    document.getElementById("unflagEvts").hidden = false;
                    document.getElementById("flagEvts").hidden = true;
                }

                if (user.Username == leader) {
                    document.getElementById("reqUnflagEvts").hidden = false;
                }
            }
        }

        window.addEventListener("DOMContentLoaded", async () => {
            // Get the current user
            let response = await fetch("/current-user", {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                }
            });
        
            let data = await response.json();
            user = data.user;
            console.log(user.Role);
            
            clubName = document.getElementById("Club Name").dataset.name;
            leader = document.getElementById("Leader").dataset.name;

            const studentButtons = document.getElementById("studentButtons");
            const leaderButtons = document.getElementById("leaderButtons");
            const dashboard = document.getElementById("dashboard");
            const admin = document.getElementById("adminDash");
            const adminFlagBtns = document.getElementsByClassName("adminFlagBtns");

            if (user.Username == leader) {
                leaderButtons.hidden = false;
                dashboard.hidden = false;
            } else {
                studentButtons.hidden = false;
            }

            if (user.Role == "admin") {
                studentButtons.hidden = true;
                dashboard.hidden = false;
                admin.hidden = false;
                document.querySelectorAll(".adminFlagBtns").forEach(btn => {
                    btn.hidden = false;
                });
            } 

            // Get the number of join requests
            response = await fetch(`/get-join-requests?club=${clubName}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                }
            });
            
            data = await response.json();
            requestNum = data.number;
            document.getElementById("requests").innerHTML = "You have " + requestNum + " new requests.";


            // Get and display flags
            response = await fetch("/grab-flags", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(clubName)
            })

            data = await response.json();
            flags = data.flags;
            displayFlags();
        });

        document.getElementById("join").addEventListener("click", async () => {

            let response = await fetch("/current-user", {
                method: "GET",
				headers: {
                    "Content-Type": "application/json"
                }
            });

            let data = await response.json();
            
            user = data.user;   
            
            let clubName = document.getElementById("Club Name").dataset.name;
            let leader = document.getElementById("Leader").dataset.name;
            
            const joinReq = {user, leader, clubName}; 

            fetch("/send-join-request", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(joinReq)
            })
            
            document.getElementById("join").hidden = true;
            document.getElementById("sent").hidden = false;

        });

        document.getElementById("studentBackBtn").addEventListener("click", () => {
            window.location.href = '/browse-clubs';
        });

        document.getElementById("leaderBackBtn").addEventListener("click", () => {
            window.location.href = '/browse-clubs';
        });

        document.getElementById("viewBtn").addEventListener("click", () => {
            let clubName = document.getElementById("Club Name").dataset.name;
            window.location.href = `/view-join-requests?club=${clubName}`;
        })

        document.getElementById("createEventBtn").addEventListener("click", () => {
            let clubName = document.getElementById("Club Name").dataset.name;
            window.location.href = `/create-event?club=${clubName}`;
        });
    
        document.getElementById("chgName").addEventListener("click", () => {
            document.getElementById("chgControls").innerHTML = "";
            
            document.getElementById("adminMessage").hidden = true;
            document.getElementById("adminMessage").innerHTML = "";
            document.getElementById("message2").innerHTML = "";
            
            document.getElementById("chgControls").hidden = false;
            const input = document.getElementById("chgControls");
            
            const tBox = document.createElement("input");
            tBox.type = "text";
            tBox.placeholder = "New Club Name";

            const confirm = document.createElement("button");
            confirm.innerText = "Confirm";

            const cancel = document.createElement("button");
            cancel.innerText = "Cancel";

            // Confirm Name Change
            confirm.addEventListener("click", async () => {
                let newName = tBox.value;
                let chgResponse = {club: clubName, leader: "", topic: "", details: "", member: "", event: "", name: newName};
                
                let response = await fetch("/manage-club", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(chgResponse)
                });

                let data = await response.json();

                if (data.status == "success") {
                    window.location.href = `/club-page?name=${encodeURIComponent(data.name)}`;
                } else {
                    document.getElementById("message").innerHTML = data.message;
                }
            });

            // Cancel Leader Change
            cancel.addEventListener("click", () => {
                const chgControls = document.getElementById("chgControls");
                chgControls.hidden = true;
                chgControls.innerHTML = "";

                document.getElementById("message").innerHTML = "";
            });
            
            input.appendChild(tBox);
            input.appendChild(confirm);
            input.appendChild(cancel);
        });

        document.getElementById("chgLeader").addEventListener("click", () => {
            document.getElementById("chgControls").innerHTML = "";

            document.getElementById("adminMessage").hidden = true;
            document.getElementById("adminMessage").innerHTML = "";
            document.getElementById("message2").innerHTML = "";
            
            document.getElementById("chgControls").hidden = false;
            const input = document.getElementById("chgControls");
            
            const tBox = document.createElement("input");
            tBox.type = "text";
            tBox.placeholder = "New Leader";

            const confirm = document.createElement("button");
            confirm.innerText = "Confirm";

            const cancel = document.createElement("button");
            cancel.innerText = "Cancel";

            // Confirm Leader Change
            confirm.addEventListener("click", async () => {
                let newLeader = tBox.value;
                let chgResponse = {club: clubName, leader: newLeader, topic: "", details: "", member: "", event: "", name: ""};
                
                let response = await fetch("/manage-club", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(chgResponse)
                });

                let data = await response.json();

                if (data.status == "success") {
                    window.location.reload();
                } else {
                    document.getElementById("message").innerHTML = data.message;
                }
            });

            // Cancel Leader Change
            cancel.addEventListener("click", () => {
                const chgControls = document.getElementById("chgControls");
                chgControls.hidden = true;
                chgControls.innerHTML = "";

                document.getElementById("message").innerHTML = "";
            });
            
            input.appendChild(tBox);
            input.appendChild(confirm);
            input.appendChild(cancel);
        });

        document.getElementById("chgTopic").addEventListener("click", () => {
            document.getElementById("chgControls").innerHTML = "";

            document.getElementById("adminMessage").hidden = true;                    
            document.getElementById("adminMessage").innerHTML = "";   
            document.getElementById("message2").innerHTML = "";             

            document.getElementById("chgControls").hidden = false;
            const input = document.getElementById("chgControls");
            
            const tBox = document.createElement("input");
            tBox.type = "text";
            tBox.placeholder = "New Topic";

            const confirm = document.createElement("button");
            confirm.innerText = "Confirm";

            const cancel = document.createElement("button");
            cancel.innerText = "Cancel";

            // Confirm Topic Change
            confirm.addEventListener("click", async () => {
                let newTopic = tBox.value;
                let chgResponse = {club: clubName, leader: "", topic: newTopic, details: "", member: "", event: "", name: ""};
                
                let response = await fetch("/manage-club", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(chgResponse)
                });

                let data = await response.json();

                if (data.status == "success") {
                    window.location.reload();
                } else {
                    document.getElementById("message").innerHTML = data.message;
                }
            });

            // Cancel Leader Change
            cancel.addEventListener("click", () => {
                const chgControls = document.getElementById("chgControls");
                chgControls.hidden = true;
                chgControls.innerHTML = "";

                document.getElementById("message").innerHTML = "";
            });
            
            input.appendChild(tBox);
            input.appendChild(confirm);
            input.appendChild(cancel);
        });

        document.getElementById("chgDetails").addEventListener("click", () => {
            document.getElementById("chgControls").innerHTML = "";

            document.getElementById("adminMessage").hidden = true;            
            document.getElementById("adminMessage").innerHTML = "";   
            document.getElementById("message2").innerHTML = "";             

            document.getElementById("chgControls").hidden = false;
            const input = document.getElementById("chgControls");
            
            const tBox = document.createElement("textarea");
            tBox.rows = 4;
            tBox.cols = 50;
            tBox.placeholder = "New Details";

            const confirm = document.createElement("button");
            confirm.innerText = "Confirm";

            const cancel = document.createElement("button");
            cancel.innerText = "Cancel";

            // Confirm Details Change
            confirm.addEventListener("click", async () => {
                let newDetails = tBox.value;
                let chgResponse = {club: clubName, leader: "", topic: "", details: newDetails, member: "", event: "", name: ""};
                
                let response = await fetch("/manage-club", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(chgResponse)
                });

                let data = await response.json();

                if (data.status == "success") {
                    window.location.reload();
                } else {
                    document.getElementById("message").innerHTML = data.message;
                }
            });

            // Cancel Leader Change
            cancel.addEventListener("click", () => {
                const chgControls = document.getElementById("chgControls");
                chgControls.hidden = true;
                chgControls.innerHTML = "";

                document.getElementById("message").innerHTML = "";
            });
            
            input.appendChild(tBox);
            input.appendChild(confirm);
            input.appendChild(cancel);
        });

        document.getElementById("rmvMembers").addEventListener("click", () => {
            document.getElementById("chgControls").innerHTML = "";

            document.getElementById("adminMessage").hidden = true;
            document.getElementById("adminMessage").innerHTML = "";
            document.getElementById("message2").innerHTML = "";

            document.getElementById("chgControls").hidden = false;
            const input = document.getElementById("chgControls");
            
            const tBox = document.createElement("input");
            tBox.type = "text";
            tBox.placeholder = "Remove Member";

            const confirm = document.createElement("button");
            confirm.innerText = "Confirm";

            const cancel = document.createElement("button");
            cancel.innerText = "Cancel";

            // Confirm Remove Member
            confirm.addEventListener("click", async () => {
                let byeMember = tBox.value;
                let chgResponse = {club: clubName, leader: "", topic: "", details: "", member: byeMember, event: "", name: ""};
                
                let response = await fetch("/manage-club", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(chgResponse)
                });

                let data = await response.json();

                if (data.status == "success") {
                    window.location.reload();
                } else {
                    document.getElementById("message").innerHTML = data.message;
                }
            });

            // Cancel Remove Member
            cancel.addEventListener("click", () => {
                const chgControls = document.getElementById("chgControls");
                chgControls.hidden = true;
                chgControls.innerHTML = "";

                document.getElementById("message").innerHTML = "";
            });

            input.appendChild(tBox);
            input.appendChild(confirm);
            input.appendChild(cancel);
        });
    
        document.getElementById("rmvEvents").addEventListener("click", () => {
            document.getElementById("chgControls").innerHTML = "";

            document.getElementById("adminMessage").hidden = true;
            document.getElementById("adminMessage").innerHTML = "";
            document.getElementById("message2").innerHTML = "";

            document.getElementById("chgControls").hidden = false;
            const input = document.getElementById("chgControls");
            
            const tBox = document.createElement("input");
            tBox.type = "text";
            tBox.placeholder = "Cancel Event";

            const confirm = document.createElement("button");
            confirm.innerText = "Confirm";

            const cancel = document.createElement("button");
            cancel.innerText = "Cancel";

            // Confirm Cancel Event
            confirm.addEventListener("click", async () => {
                let cnclEvent = tBox.value;
                let chgResponse = {club: clubName, leader: "", topic: "", details: "", member: "", event: cnclEvent, name: ""};
                
                let response = await fetch("/manage-club", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(chgResponse)
                });

                let data = await response.json();

                if (data.status == "success") {
                    window.location.reload();
                } else {
                    document.getElementById("message").innerHTML = data.message;
                }
            });

            // Cancel Remove Member
            cancel.addEventListener("click", () => {
                const chgControls = document.getElementById("chgControls");
                chgControls.hidden = true;
                chgControls.innerHTML = "";

                document.getElementById("message").innerHTML = "";
            });

            input.appendChild(tBox);
            input.appendChild(confirm);
            input.appendChild(cancel);
        });
    
        /*document.getElementById("flagBtn").addEventListener("click", () => {
            document.getElementById("chgControls").innerHTML = "";
            document.getElementById("message").innerHTML = "";
            document.getElementById("adminMessage").innerHTML = "";

            document.getElementById("adminMessage").hidden = false;
            const input = document.getElementById("adminMessage");
            
            const tBox = document.createElement("textarea");
            tBox.rows = 4;
            tBox.cols = 50;
            tBox.placeholder = "Message";

            const confirm = document.createElement("button");
            confirm.innerText = "Confirm";

            const cancel = document.createElement("button");
            cancel.innerText = "Cancel";

            //adminMsg

            // Confirm Flag Message
            confirm.addEventListener("click", async () => {
                let actMessage = tBox.value;
                let flgResponse = {type: "Club", name: clubName, message: actMessage};
                let data = {};

                if (flgResponse["message"] == "") {
                    document.getElementById("message2").innerHTML = "Must enter a flag message.";
                } else {
                    let response = await fetch("/flag-content", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(flgResponse)
                    });

                    data = await response.json();
                }
                
                
                if (data.status == "success") {
                    window.location.reload();
                }
            });

            // Cancel Leader Change
            cancel.addEventListener("click", () => {
                document.getElementById("adminMessage").hidden = true;
                document.getElementById("adminMessage").innerHTML = "";
                document.getElementById("message2").innerHTML = "";
            });

            input.appendChild(tBox);
            input.appendChild(confirm);
            input.appendChild(cancel);
        });*/

        document.getElementById("adminBackBtn").addEventListener("click", () => {
             window.location.href = '/admin';
        });
    
        document.querySelectorAll(".adminFlagBtns").forEach(btn => {
            btn.addEventListener("click", async () => {
                let flag = {};
                
                if (btn.id == "flagName") {
                    flag = {"type": "club", "name": clubName, "section": "Club Name"};
                }

                if (btn.id == "flagLdr") {
                    flag = {"type": "club", "name": clubName, "section": "Leader"};
                }

                if (btn.id == "flagTpc") {
                    flag = {"type": "club", "name": clubName, "section": "Topic"};
                }

                if (btn.id == "flagDtls") {
                    flag = {"type": "club", "name": clubName, "section": "Details"};
                }

                if (btn.id == "flagMbrs") {
                    flag = {"type": "club", "name": clubName, "section": "Members"};
                }

                if (btn.id == "flagEvts") {
                    flag = {"type": "club", "name": clubName, "section": "Events"};
                }

                let response = await fetch("/flag-content", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(flag)
                });

                window.location.reload();
            });
        });
    
        document.querySelectorAll(".adminUnflagBtns").forEach(btn => {
            btn.addEventListener("click", async () => {
                let unflag = {};
                
                if (btn.id == "unflagName") {
                    unflag = {"type": "club", "name": clubName, "section": "Club Name"};
                }

                if (btn.id == "unflagLdr") {
                    unflag = {"type": "club", "name": clubName, "section": "Leader"};
                }

                if (btn.id == "unflagTpc") {
                    unflag = {"type": "club", "name": clubName, "section": "Topic"};
                }

                if (btn.id == "unflagDtls") {
                    unflag = {"type": "club", "name": clubName, "section": "Details"};
                }

                if (btn.id == "unflagMbrs") {
                    unflag = {"type": "club", "name": clubName, "section": "Members"};
                }

                if (btn.id == "unflagEvts") {
                    unflag = {"type": "club", "name": clubName, "section": "Events"};
                }

                let response = await fetch("/unflag-content", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(unflag)
                });

                window.location.reload();
            });
        });
    </script>
</body>
</html>